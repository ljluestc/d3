<scriptsetup>import*asPlotfrom"@observablehq/plot";import*asd3from"d3";import{ref,shallowRef,onMounted}from"vue";importPlotRenderfrom"../components/PlotRender.js";constriaa=shallowRef([]);onMounted(()=>{d3.csv("../data/riaa-us-revenue.csv",d3.autoType).then((data)=>(riaa.value=data));});</script>#Stacks<!--https://observablehq.com/@mbostock/streamgraph-transitions-->[Examples](https://observablehq.com/@d3/stacked-bar-chart/2?intent=fork)·Stackingconvertslengthsintocontiguouspositionintervals.Forexample,abarchartofmonthlysalesmightbebrokendownintoamulti-seriesbarchartbycategory,stackingbarsverticallyandapplyingacategoricalcolorencoding.Stackedchartscanshowoverallvalueandper-categoryvaluesimultaneously;however,itistypicallyhardertocompareacrosscategoriesasonlythebottomlayerofthestackisaligned.So,chosethe[stackorder](#stack_order)carefully,andconsidera[streamgraph](#stackOffsetWiggle).(Seealso[groupedcharts](https://observablehq.com/@d3/grouped-bar-chart/2?intent=fork).)Likethe[piegenerator](./pie.md),thestackgeneratordoesnotproduceashapedirectly.Insteaditcomputespositionswhichyoucanthenpasstoan[areagenerator](./area.md)orusedirectly,saytopositionbars.##stack(){#stack}[Source](https://github.com/d3/d3-shape/blob/main/src/stack.js)·Constructsanewstackgeneratorwiththedefaultsettings.See[*stack*](#_stack)forusage.##*stack*(*data*,...*arguments*){#_stack}[Source](https://github.com/d3/d3-shape/blob/main/src/stack.js)·Generatesastackforthegivenarrayof*data*andreturnsanarrayrepresentingeachseries.Anyadditional*arguments*arearbitrary;theyarepropagatedtoaccessorsalongwiththe`this`object.Forexample,considerthistidytableofmonthlyfruitsales:date|fruit|sales--------|----------|--------:1/2015|apples|38401/2015|bananas|19201/2015|cherries|9601/2015|durians|4002/2015|apples|16002/2015|bananas|14402/2015|cherries|9602/2015|durians|4003/2015|apples|6403/2015|bananas|9603/2015|cherries|6403/2015|durians|4004/2015|apples|3204/2015|bananas|4804/2015|cherries|6404/2015|durians|400ThiscouldberepresentedinJavaScriptasanarrayofobjects,perhapsparsedfrom[CSV](../d3-dsv.md):```jsconstdata=[{date:newDate("2015-01-01"),fruit:"apples",sales:3840},{date:newDate("2015-01-01"),fruit:"bananas",sales:1920},{date:newDate("2015-01-01"),fruit:"cherries",sales:960},{date:newDate("2015-01-01"),fruit:"durians",sales:400},{date:newDate("2015-02-01"),fruit:"apples",sales:1600},{date:newDate("2015-02-01"),fruit:"bananas",sales:1440},{date:newDate("2015-02-01"),fruit:"cherries",sales:960},{date:newDate("2015-02-01"),fruit:"durians",sales:400},{date:newDate("2015-03-01"),fruit:"apples",sales:640},{date:newDate("2015-03-01"),fruit:"bananas",sales:960},{date:newDate("2015-03-01"),fruit:"cherries",sales:640},{date:newDate("2015-03-01"),fruit:"durians",sales:400},{date:newDate("2015-04-01"),fruit:"apples",sales:320},{date:newDate("2015-04-01"),fruit:"bananas",sales:480},{date:newDate("2015-04-01"),fruit:"cherries",sales:640},{date:newDate("2015-04-01"),fruit:"durians",sales:400}];```Tocomputethestackedseries(aseries,orlayer,foreach*fruit*;andastack,orcolumn,foreach*date*),wecan[index](../d3-array/group.md#index)thedataby*date*andthen*fruit*,computethedistinct*fruit*namesacrossthedataset,andlastlygetthe*sales*valueforeach*date*and*fruit*.```jsconstseries=d3.stack().keys(d3.union(data.map(d=>d.fruit)))//apples,bananas,cherries,….value(([,group],key)=>group.get(key).sales)(d3.index(data,d=>d.date,d=>d.fruit));```:::tipSee[union](../d3-array/sets.md#union)and[index](../d3-array/group.md#index)fromd3-array.:::Theresultingarrayhasoneelementper*series*.Eachserieshasonepointpermonth,andeachpointhasaloweranduppervaluedefiningthebaselineandtopline:```js[[[0,3840],[0,1600],[0,640],[0,320]],//apples[[3840,5760],[1600,3040],[640,1600],[320,800]],//bananas[[5760,6720],[3040,4000],[1600,2240],[800,1440]],//cherries[[6720,7120],[4000,4400],[2240,2640],[1440,1840]]//durians]```Eachseriesinthentypicallypassedtoan[areagenerator](./area.md)torenderanareachart,orusedtoconstructrectanglesforabarchart.```jssvg.append("g").selectAll("g").data(series).join("g").attr("fill",d=>color(d.key)).selectAll("rect").data(D=>D).join("rect").attr("x",d=>x(d.data[0])).attr("y",d=>y(d[1])).attr("height",d=>y(d[0])-y(d[1])).attr("width",x.bandwidth());```Theseriesaredeterminedbythe[keysaccessor](#stack_keys);eachseries*i*inthereturnedarraycorrespondstothe*i*thkey.Eachseriesisanarrayofpoints,whereeachpoint*j*correspondstothe*j*thelementintheinput*data*.Lastly,eachpointisrepresentedasanarray[*y0*,*y1*]where*y0*isthelowervalue(baseline)and*y1*istheuppervalue(topline);thedifferencebetween*y0*and*y1*correspondstothecomputed[value](#stack_value)forthispoint.Thekeyforeachseriesisavailableas*series*.key,andthe[index](#stack_order)as*series*.index.Theinputdataelementforeachpointisavailableas*point*.data.##*stack*.keys(*keys*){#stack_keys}[Source](https://github.com/d3/d3-shape/blob/main/src/stack.js)·If*keys*isspecified,setsthekeysaccessortothespecifiedfunctionorarrayandreturnsthisstackgenerator.```jsconststack=d3.stack().keys(["apples","bananas","cherries","durians"]);```If*keys*isnotspecified,returnsthecurrentkeysaccessor.```jsstack.keys()//()=>["apples","bananas","cherries","durians"]```Thekeysaccessordefaultstotheemptyarray.Aseries(layer)is[generated](#_stack)foreachkey.Keysaretypicallystrings,buttheymaybearbitraryvalues;see[InternMap](../d3-array/intern.md).Theseries’keyispassedtothe[valueaccessor](#stack_value),alongwitheachdatapoint,tocomputethepoint’svalue.##*stack*.value(*value*){#stack_value}[Source](https://github.com/d3/d3-shape/blob/main/src/stack.js)·If*value*isspecified,setsthevalueaccessortothespecifiedfunctionornumberandreturnsthisstackgenerator.```jsconststack=d3.stack().value((d,key)=>d[key]);```If*value*isnotspecified,returnsthecurrentvalueaccessor.```jsstack.value()//(d,key)=>d[key]```Thevalueaccessordefaultsto:```jsfunctionvalue(d,key){returnd[key];}```:::warningCAUTIONThedefaultvalueaccessorassumesthattheinputdataisanarrayofobjectsexposingnamedpropertieswithnumericvalues.Thisisa“wide”ratherthan“tidy”representationofdataandisnolongerrecommended.See[*stack*](#_stack)foranexampleusingtidydata.:::##*stack*.order(*order*){#stack_order}[Source](https://github.com/d3/d3-shape/blob/main/src/stack.js)·If*order*isspecified,setstheorderaccessortothespecifiedfunctionorarrayandreturnsthisstackgenerator.```jsconststack=d3.stack().order(d3.stackOrderNone);```If*order*isafunction,itispassedthegeneratedseriesarrayandmustreturnanarrayofnumericindexesrepresentingthestackorder.Forexample,tousereversekeyorder:```jsconststack=d3.stack().order(series=>d3.range(series.length).reverse());```Thestackorderiscomputedpriortothe[offset](#stack_offset);thus,thelowervalueforallpointsiszeroatthetimetheorderiscomputed.Theindexattributeforeachseriesisalsonotsetuntilaftertheorderiscomputed.If*order*isnotspecified,returnsthecurrentorderaccessor.```jsstack.order()//d3.stackOrderNone```Theorderaccessordefaultsto[stackOrderNone](#stackOrderNone);thisusestheordergivenbythe[keyaccessor](#stack_keys).See[stackorders](#stack-orders)forthebuilt-inorders.##*stack*.offset(*offset*){#stack_offset}[Source](https://github.com/d3/d3-shape/blob/main/src/stack.js)·If*offset*isspecified,setstheoffsetaccessortothespecifiedfunctionandreturnsthisstackgenerator.```jsconststack=d3.stack().offset(d3.stackOffsetExpand);```Theoffsetfunctionispassedthegeneratedseriesarrayandtheorderindexarray;itisthenresponsibleforupdatingtheloweranduppervaluesintheseriesarray.Seethebuilt-inoffsetsforareferenceimplementation.If*offset*isnotspecified,returnsthecurrentoffsetacccesor.```jsstack.offset()//d3.stackOffsetExpand```Theoffsetaccessordefaultsto[stackOffsetNone](#stackOffsetNone);thisusesazerobaseline.See[stackoffsets](#stack-offsets)forthebuilt-inoffsets.##StackordersStackordersaretypicallynotuseddirectly,butareinsteadpassedto[*stack*.order](#stack_order).###stackOrderAppearance(*series*){#stackOrderAppearance}<PlotRenderdefer:options='{height:200,y:{grid:true,label:"Annualrevenue(billions)",transform:(d)=>d/1000//convertmillionstobillions},marks:[Plot.areaY(riaa,{x:"year",y:"revenue",z:"format",fill:"group",order:"appearance"}),Plot.ruleY([0])]}'/>```jsconststack=d3.stack().order(d3.stackOrderAppearance);```[Source](https://github.com/d3/d3-shape/blob/main/src/order/appearance.js)·Returnsaseriesordersuchthattheearliestseries(accordingtothemaximumvalue)isatthebottom.###stackOrderAscending(*series*){#stackOrderAscending}<PlotRenderdefer:options='{height:200,y:{grid:true,label:"Annualrevenue(billions)",transform:(d)=>d/1000//convertmillionstobillions},marks:[Plot.areaY(riaa,{x:"year",y:"revenue",z:"format",fill:"group",order:"sum"}),Plot.ruleY([0])]}'/>```jsconststack=d3.stack().order(d3.stackOrderAscending);```[Source](https://github.com/d3/d3-shape/blob/main/src/order/ascending.js)·Returnsaseriesordersuchthatthesmallestseries(accordingtothesumofvalues)isatthebottom.###stackOrderDescending(*series*){#stackOrderDescending}<PlotRenderdefer:options='{height:200,y:{grid:true,label:"Annualrevenue(billions)",transform:(d)=>d/1000//convertmillionstobillions},marks:[Plot.areaY(riaa,{x:"year",y:"revenue",z:"format",fill:"group",order:"-sum"}),Plot.ruleY([0])]}'/>```jsconststack=d3.stack().order(d3.stackOrderDescending);```[Source](https://github.com/d3/d3-shape/blob/main/src/order/descending.js)·Returnsaseriesordersuchthatthelargestseries(accordingtothesumofvalues)isatthebottom.###stackOrderInsideOut(*series*){#stackOrderInsideOut}<PlotRenderdefer:options='{height:200,y:{grid:true,label:"Annualrevenue(billions)",transform:(d)=>d/1000//convertmillionstobillions},marks:[Plot.areaY(riaa,{x:"year",y:"revenue",z:"format",fill:"group",offset:"wiggle",order:"inside-out"}),]}'/>```jsconststack=d3.stack().order(d3.stackOrderInsideOut);```[Source](https://github.com/d3/d3-shape/blob/main/src/order/insideOut.js)·Returnsaseriesordersuchthattheearliestseries(accordingtothemaximumvalue)areontheinsideandthelaterseriesareontheoutside.Thisorderisrecommendedforstreamgraphsinconjunctionwiththe[wiggleoffset](#stackOffsetWiggle).See[StackedGraphs—Geometry&Aesthetics](http://leebyron.com/streamgraph/)byByron&Wattenbergformoreinformation.###stackOrderNone(*series*){#stackOrderNone}<PlotRenderdefer:options='{height:200,y:{grid:true,label:"Annualrevenue(billions)",transform:(d)=>d/1000//convertmillionstobillions},marks:[Plot.areaY(riaa,{x:"year",y:"revenue",z:"format",fill:"group",order:null}),Plot.ruleY([0])]}'/>```jsconststack=d3.stack().order(d3.stackOrderNone);```[Source](https://github.com/d3/d3-shape/blob/main/src/order/none.js)·Returnsthegivenseriesorder[0,1,…*n*-1]where*n*isthenumberofelementsin*series*.Thus,thestackorderisgivenbythe[keyaccessor](#stack_keys).###stackOrderReverse(*series*){#stackOrderReverse}<PlotRenderdefer:options='{height:200,y:{grid:true,label:"Annualrevenue(billions)",transform:(d)=>d/1000//convertmillionstobillions},marks:[Plot.areaY(riaa,{x:"year",y:"revenue",z:"format",fill:"group",order:null,reverse:true}),Plot.ruleY([0])]}'/>```jsconststack=d3.stack().order(d3.stackOrderReverse);```[Source](https://github.com/d3/d3-shape/blob/main/src/order/reverse.js)·Returnsthereverseofthegivenseriesorder[*n*-1,*n*-2,…0]where*n*isthenumberofelementsin*series*.Thus,thestackorderisgivenbythereverseofthe[keyaccessor](#stack_keys).##StackoffsetsStackoffsetsaretypicallynotuseddirectly,butareinsteadpassedto[*stack*.offset](#stack_offset).###stackOffsetExpand(*series*,*order*){#stackOffsetExpand}<PlotRenderdefer:options='{height:200,y:{grid:true,label:"Annualrevenue(%)",percent:true},marks:[Plot.areaY(riaa,{x:"year",y:"revenue",z:"format",fill:"group",offset:"expand",order:"-appearance"}),Plot.ruleY([0])]}'/>```jsconststack=d3.stack().offset(d3.stackOffsetExpand);```[Source](https://github.com/d3/d3-shape/blob/main/src/offset/expand.js)·Appliesazerobaselineandnormalizesthevaluesforeachpointsuchthatthetoplineisalwaysone.###stackOffsetDiverging(*series*,*order*){#stackOffsetDiverging}<PlotRenderdefer:options='{height:200,y:{grid:true,label:"Annualrevenue(billions)",transform:(d)=>d/1e3},marks:[Plot.areaY(riaa,{x:"year",y:(d)=>(d.group==="Disc"?-1:1)*d.revenue,z:"format",fill:"group",order:"appearance"}),Plot.ruleY([0])]}'/>```jsconststack=d3.stack().offset(d3.stackOffsetDiverging);```[Source](https://github.com/d3/d3-shape/blob/main/src/offset/diverging.js)·Positivevaluesarestackedabovezero,negativevaluesare[stackedbelowzero](https://observablehq.com/@d3/diverging-stacked-bar-chart/2?intent=fork),andzerovaluesarestackedatzero.###stackOffsetNone(*series*,*order*){#stackOffsetNone}<PlotRenderdefer:options='{height:200,y:{grid:true,label:"Annualrevenue(billions)",transform:(d)=>d/1e3},marks:[Plot.areaY(riaa,{x:"year",y:"revenue",z:"format",fill:"group",order:"appearance"}),Plot.ruleY([0])]}'/>```jsconststack=d3.stack().offset(d3.stackOffsetNone);```[Source](https://github.com/d3/d3-shape/blob/main/src/offset/none.js)·Appliesazerobaseline.###stackOffsetSilhouette(*series*,*order*){#stackOffsetSilhouette}<PlotRenderdefer:options='{height:200,y:{grid:true,label:"Annualrevenue(billions)",transform:(d)=>d/1e3},marks:[Plot.areaY(riaa,{x:"year",y:"revenue",z:"format",fill:"group",offset:"center",order:"appearance"})]}'/>```jsconststack=d3.stack().offset(d3.stackOffsetSilhouette);```[Source](https://github.com/d3/d3-shape/blob/main/src/offset/silhouette.js)·Shiftsthebaselinedownsuchthatthecenterofthestreamgraphisalwaysatzero.###stackOffsetWiggle(*series*,*order*){#stackOffsetWiggle}<PlotRenderdefer:options='{height:200,y:{grid:true,label:"Annualrevenue(billions)",transform:(d)=>d/1e3},marks:[Plot.areaY(riaa,{x:"year",y:"revenue",z:"format",fill:"group",offset:"wiggle"})]}'/>```jsconststack=d3.stack().offset(d3.stackOffsetWiggle);```[Source](https://github.com/d3/d3-shape/blob/main/src/offset/wiggle.js)·Shiftsthebaselinesoastominimizetheweightedwiggleoflayers.Thisoffsetisrecommendedforstreamgraphsinconjunctionwiththe[inside-outorder](#stackOrderInsideOut).See[StackedGraphs—Geometry&Aesthetics](http://leebyron.com/streamgraph/)byBryon&Wattenbergformoreinformation.