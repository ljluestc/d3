<scriptsetup>import*asPlotfrom"@observablehq/plot";import*asd3from"d3";import{computed,shallowRef,onMounted}from"vue";importExampleAnimatedQuadtreefrom"./components/ExampleAnimatedQuadtree.vue";importPlotRenderfrom"./components/PlotRender.js";importquadtree_findVisitedfrom"./components/quadtreeFindVisited.js";importquadtree_nodesfrom"./components/quadtreeNodes.js";constrandom=d3.randomNormal.source(d3.randomLcg(42))();constpoints=Array.from({length:1000},()=>[random(),random()]);consttree=d3.quadtree(d3.range(points.length),(i)=>points[i][0],(i)=>points[i][1]);constfindState=shallowRef({x:0,y:0,i:-1});</script>#d3-quadtree<ExampleAnimatedQuadtree:points="points"/>A[quadtree](https://en.wikipedia.org/wiki/Quadtree)recursivelypartitionstwo-dimensionalspaceintosquares,dividingeachsquareintofourequally-sizedsquares.Eachdistinctpointexistsinauniqueleaf[node](#quadtree-nodes);coincidentpointsarerepresentedbyalinkedlist.Quadtreescanacceleratevariousspatialoperations,suchasthe[Barnes–Hutapproximation](https://en.wikipedia.org/wiki/Barnes–Hut_simulation)forcomputingmany-bodyforces,collisiondetection,andsearchingfornearbypoints.<!--http://bl.ocks.org/mbostock/9078690--><!--http://bl.ocks.org/mbostock/4343214-->##quadtree(*data*,*x*,*y*){#quadtree}[Source](https://github.com/d3/d3-quadtree/blob/main/src/quadtree.js)·Createsanew,emptyquadtreewithanempty[extent](#quadtree_extent)andthedefault[x](#quadtree_x)and[y](#quadtree_y)accessors.If*data*isspecified,[adds](#quadtree_addAll)thespecifiediterableofdatatothequadtree.```jsconsttree=d3.quadtree(data);```Thisisequivalentto:```jsconsttree=d3.quadtree().addAll(data);```If*x*and*y*arealsospecified,setsthe[x](#quadtree_x)and[y](#quadtree_y)accessorstothespecifiedfunctionsbeforeaddingthespecifiediterableofdatatothequadtree,equivalentto:```jsconsttree=d3.quadtree().x(x).y(y).addAll(data);```##*quadtree*.x(x){#quadtree_x}[Source](https://github.com/d3/d3-quadtree/blob/main/src/x.js)·If*x*isspecified,setsthecurrentx-coordinateaccessorandreturnsthequadtree.```jsconsttree=d3.quadtree().x((d)=>d.x);```Thexaccessorisusedtoderivethexcoordinateofdatawhen[adding](#quadtree_add)toand[removing](#quadtree_remove)fromthetree.Itisalsousedwhen[finding](#quadtree_find)tore-accessthecoordinatesofdatapreviouslyaddedtothetree;therefore,thexandyaccessorsmustbeconsistent,returningthesamevaluegiventhesameinput.If*x*isnotspecified,returnsthecurrentxaccessor.```jstree.x()//(d)=>d.x```Thexaccessordefaultsto:```jsfunctionx(d){returnd[0];}```##*quadtree*.y(y){#quadtree_y}[Source](https://github.com/d3/d3-quadtree/blob/main/src/y.js)·If*y*isspecified,setsthecurrenty-coordinateaccessorandreturnsthequadtree.```jsconsttree=d3.quadtree().y((d)=>d.y);```Theyaccessorisusedtoderivetheycoordinateofdatawhen[adding](#quadtree_add)toand[removing](#quadtree_remove)fromthetree.Itisalsousedwhen[finding](#quadtree_find)tore-accessthecoordinatesofdatapreviouslyaddedtothetree;therefore,thexandyaccessorsmustbeconsistent,returningthesamevaluegiventhesameinput.If*y*isnotspecified,returnsthecurrentyaccessor.```jstree.y()//(d)=>d.y```Theyaccessordefaultsto:```jsfunctiony(d){returnd[1];}```##*quadtree*.extent(*extent*){#quadtree_extent}[Source](https://github.com/d3/d3-quadtree/blob/main/src/extent.js)·If*extent*isspecified,expandsthequadtreeto[cover](#quadtree_cover)thespecifiedpoints[[*x0*,*y0*],[*x1*,*y1*]]andreturnsthequadtree.```jsconsttree=d3.quadtree().extent([[0,0],[1,1]]);```If*extent*isnotspecified,returnsthequadtree’scurrentextent[[*x0*,*y0*],[*x1*,*y1*]],where*x0*and*y0*aretheinclusivelowerboundsand*x1*and*y1*aretheinclusiveupperbounds,orundefinedifthequadtreehasnoextent.```jstree.extent()//[[0,0],[2,2]]```Theextentmayalsobeexpandedbycalling[*quadtree*.cover](#quadtree_cover)or[*quadtree*.add](#quadtree_add).##*quadtree*.cover(*x*,*y*){#quadtree_cover}[Source](https://github.com/d3/d3-quadtree/blob/main/src/cover.js)·Expandsthequadtreetocoverthespecifiedpoint⟨*x*,*y*⟩,andreturnsthequadtree.```jsconsttree=d3.quadtree().cover(0,0).cover(1,1);```Ifthequadtree’sextentalreadycoversthespecifiedpoint,thismethoddoesnothing.Ifthequadtreehasanextent,theextentisrepeatedlydoubledtocoverthespecifiedpoint,wrappingthe[root](#quadtree_root)[node](#quadtree-nodes)asnecessary;ifthequadtreeisempty,theextentisinitializedtotheextent[[⌊*x*⌋,⌊*y*⌋],[⌈*x*⌉,⌈*y*⌉]].(Roundingisnecessarysuchthatiftheextentislaterdoubled,theboundariesofexistingquadrantsdonotchangeduetofloatingpointerror.)##*quadtree*.add(*datum*){#quadtree_add}[Source](https://github.com/d3/d3-quadtree/blob/main/src/add.js)·Addsthespecified*datum*tothequadtree,derivingitscoordinates⟨*x*,*y*⟩usingthecurrent[x](#quadtree_x)and[y](#quadtree_y)accessors,andreturnsthequadtree.```jsconsttree=d3.quadtree().add([0,0]);```Ifthenewpointisoutsidethecurrent[extent](#quadtree_extent)ofthequadtree,thequadtreeisautomaticallyexpandedto[cover](#quadtree_cover)thenewpoint.##*quadtree*.addAll(*data*){#quadtree_addAll}[Source](https://github.com/d3/d3-quadtree/blob/main/src/add.js)·Addsthespecifiediterableof*data*tothequadtree,derivingeachelement’scoordinates⟨*x*,*y*⟩usingthecurrent[x](#quadtree_x)and[y](#quadtree_y)accessors,andreturnthisquadtree.```jsconsttree=d3.quadtree().addAll([[0,0],[1,2]]);```Thisisapproximatelyequivalenttocalling[*quadtree*.add](#quadtree_add)repeatedly:```jsfor(leti=0,n=data.length;i<n;++i){quadtree.add(data[i]);}```However,thismethodresultsinamorecompactquadtreebecausetheextentofthe*data*iscomputedfirstbeforeaddingthedata.##*quadtree*.remove(*datum*){#quadtree_remove}[Source](https://github.com/d3/d3-quadtree/blob/main/src/remove.js)·Removesthespecified*datum*fromthequadtree,derivingitscoordinates⟨*x*,*y*⟩usingthecurrent[x](#quadtree_x)and[y](#quadtree_y)accessors,andreturnsthequadtree.```jstree.remove(data[0]);```Ifthespecified*datum*doesnotexistinthisquadtree(asdeterminedbystrictequalitywith*datum*,andindependentofthecomputedposition),thismethoddoesnothing.##*quadtree*.removeAll(*data*){#quadtree_removeAll}[Source](https://github.com/d3/d3-quadtree/blob/main/src/remove.js)·Removesthespecified*data*fromthequadtree,derivingtheircoordinates⟨*x*,*y*⟩usingthecurrent[x](#quadtree_x)and[y](#quadtree_y)accessors,andreturnsthequadtree.```jstree.removeAll(data);```Ifaspecifieddatumdoesnotexistinthisquadtree(asdeterminedbystrictequalitywith*datum*,andindependentofthecomputedposition),itisignored.##*quadtree*.copy(){#quadtree_copy}```jsconstt1=d3.quadtree(data);constt2=t1.copy();```[Source](https://github.com/d3/d3-quadtree/blob/main/src/quadtree.js)·Returnsacopyofthequadtree.All[nodes](#quadtree-nodes)inthereturnedquadtreeareidenticalcopiesofthecorrespondingnodeinthequadtree;however,anydatainthequadtreeissharedbyreferenceandnotcopied.##*quadtree*.root(){#quadtree_root}[Source](https://github.com/d3/d3-quadtree/blob/main/src/root.js)·Returnstheroot[node](#quadtree-nodes)ofthequadtree.```jstree.root()//[{…},empty×2,{…}]```##*quadtree*.data(){#quadtree_data}[Source](https://github.com/d3/d3-quadtree/blob/main/src/data.js)·Returnsanarrayofalldatainthequadtree.```jstree.data()//[[0,0],[1,2]]```##*quadtree*.size(){#quadtree_size}[Source](https://github.com/d3/d3-quadtree/blob/main/src/size.js)·Returnsthetotalnumberofdatainthequadtree.```jstree.size()//2```##*quadtree*.find(*x*,*y*,*radius*){#quadtree_find}<PlotRenderdeferv-once:options='{axis:null,aspectRatio:1,round:true,marks:[Plot.dot(points,{r:2,fill:"currentColor"}),Plot.rect(quadtree_nodes.call(tree),{stroke:"currentColor",x1:"x1",y1:"y1",x2:"x2",y2:"y2"}),Plot.rect({length:1},{stroke:"red",strokeOpacity:0.5,render(index,scales,values,dimensions,context,next){functionupdate(x,y){constvisited=quadtree_findVisited.call(tree,x,y);returnnext(d3.range(visited.length),scales,{x1:visited.map((d,i)=>scales.x(d.x0)+d.dx0),y1:visited.map((d,i)=>scales.y(d.y0)-d.dy0),x2:visited.map((d,i)=>scales.x(d.x1)+d.dx1),y2:visited.map((d,i)=>scales.y(d.y1)-d.dy1)},dimensions,context);}letrect=update(0,0);context.ownerSVGElement.addEventListener("pointermove",(event)=>{const[x,y]=d3.pointer(event);constnewrect=update(scales.x.invert(x),scales.y.invert(y));rect.replaceWith(newrect);rect=newrect;});returnrect;}}),Plot.dot(points,{r:3.5,stroke:"red",strokeWidth:3,render(index,scales,values,dimensions,context,next){functionupdate(x,y){consti=tree.find(x,y);findState={x,y,i};returnnext([i],scales,values,dimensions,context);}letdot=update(0,0);context.ownerSVGElement.addEventListener("pointermove",(event)=>{const[x,y]=d3.pointer(event);constnewdot=update(scales.x.invert(x),scales.y.invert(y));dot.replaceWith(newdot);dot=newdot;});returndot;}}),]}'/>[Source](https://github.com/d3/d3-quadtree/blob/main/src/find.js)·Returnsthedatumclosesttotheposition⟨*x*,*y*⟩withthegivensearch*radius*.If*radius*isnotspecified,itdefaultstoinfinity.```js-vuetree.find({{findState.x.toFixed(3)}},{{findState.y.toFixed(3)}})//{{points[findState.i]&&`[${points[findState.i].map((p)=>p.toFixed(3)).join(",")}]`}}```Ifthereisnodatumwithinthesearcharea,returnsundefined.```jstree.find(10,10,1)//undefined```##*quadtree*.visit(*callback*){#quadtree_visit}[Source](https://github.com/d3/d3-quadtree/blob/main/src/visit.js)·Visitseach[node](#quadtree-nodes)inthequadtreeinpre-ordertraversal,invokingthespecified*callback*witharguments*node*,*x0*,*y0*,*x1*,*y1*foreachnode,where*node*isthenodebeingvisited,⟨*x0*,*y0*⟩arethelowerboundsofthenode,and⟨*x1*,*y1*⟩aretheupperbounds,andreturnsthequadtree.(Assumingthatpositive*x*isrightandpositive*y*isdown,asistypicallythecaseinCanvasandSVG,⟨*x0*,*y0*⟩isthetop-leftcornerand⟨*x1*,*y1*⟩isthelower-rightcorner;however,thecoordinatesystemisarbitrary,somoreformally*x0*<=*x1*and*y0*<=*y1*.)Ifthe*callback*returnstrueforagivennode,thenthechildrenofthatnodearenotvisited;otherwise,allchildnodesarevisited.Thiscanbeusedtoquicklyvisitonlypartsofthetree,forexamplewhenusingthe[Barnes–Hutapproximation](https://en.wikipedia.org/wiki/Barnes–Hut_simulation).Note,however,thatchildquadrantsarealwaysvisitedinsiblingorder:top-left,top-right,bottom-left,bottom-right.Incasessuchas[search](#quadtree_find),visitingsiblingsinaspecificordermaybefaster.Asanexample,thefollowingvisitsthequadtreeandreturnsallthenodeswithinarectangularextent[xmin,ymin,xmax,ymax],ignoringquadsthatcannotpossiblycontainanysuchnode:```jsfunctionsearch(quadtree,xmin,ymin,xmax,ymax){constresults=[];quadtree.visit((node,x1,y1,x2,y2)=>{if(!node.length){do{letd=node.data;if(d[0]>=xmin&&d[0]<xmax&&d[1]>=ymin&&d[1]<ymax){results.push(d);}}while(node=node.next);}returnx1>=xmax||y1>=ymax||x2<xmin||y2<ymin;});returnresults;}```##*quadtree*.visitAfter(*callback*){#quadtree_visitAfter}[Source](https://github.com/d3/d3-quadtree/blob/main/src/visitAfter.js)·Visitseach[node](#quadtree-nodes)inthequadtreeinpost-ordertraversal,invokingthespecified*callback*witharguments*node*,*x0*,*y0*,*x1*,*y1*foreachnode,where*node*isthenodebeingvisited,⟨*x0*,*y0*⟩arethelowerboundsofthenode,and⟨*x1*,*y1*⟩aretheupperbounds,andreturnsthequadtree.(Assumingthatpositive*x*isrightandpositive*y*isdown,asistypicallythecaseinCanvasandSVG,⟨*x0*,*y0*⟩isthetop-leftcornerand⟨*x1*,*y1*⟩isthelower-rightcorner;however,thecoordinatesystemisarbitrary,somoreformally*x0*<=*x1*and*y0*<=*y1*.)Returns*root*.##QuadtreenodesInternalnodesofthequadtreearerepresentedassparsefour-elementarraysinleft-to-right,top-to-bottomorder:*`0`-thetop-leftquadrant,ifany.*`1`-thetop-rightquadrant,ifany.*`2`-thebottom-leftquadrant,ifany.*`3`-thebottom-rightquadrant,ifany.Achildquadrantmaybeundefinedifitisempty.Leafnodesarerepresentedasobjectswiththefollowingproperties:*`data`-thedataassociatedwiththispoint,aspassedto[*quadtree*.add](#quadtree_add).*`next`-thenextdatuminthisleaf,ifany.The`length`propertymaybeusedtodistinguishleafnodesfrominternalnodes:itisundefinedforleafnodes,and4forinternalnodes.Forexample,toiterateoveralldatainaleafnode:```jsif(!node.length)doconsole.log(node.data);while(node=node.next);```Thepoint’sxandycoordinates**mustnotbemodified**whilethepointisinthequadtree.Toupdateapoint’sposition,[remove](#quadtree_remove)thepointandthenre-[add](#quadtree_add)ittothequadtreeatthenewposition.Alternatively,youmaydiscardtheexistingquadtreeentirelyandcreateanewonefromscratch;thismaybemoreefficientifmanyofthepointshavemoved.